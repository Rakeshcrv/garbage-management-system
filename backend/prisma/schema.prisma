// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id          Int    @id @default(autoincrement())
  name        String
  email       String @unique
  password    String
  role        String // Admin, Worker, Citizen
  profileImage String? // Profile picture file path

  // Relations
  pickupRequestsAsCitizen PickupRequest[] @relation("CitizenRequests")
  pickupRequestsAsWorker  PickupRequest[] @relation("WorkerRequests")
  garbageReports          GarbageReport[]
  worker                  Worker?
  assignedReports         GarbageReport[] @relation("WorkerAssignments")
}

model PickupRequest {
  id          Int      @id @default(autoincrement())
  address     String
  garbageType String   // Dry, Wet, E-waste
  pickupDate  DateTime
  status      String   @default("Pending") // Pending, Assigned, Collected
  citizenId   Int
  workerId    Int?

  // Relations
  citizen User @relation("CitizenRequests", fields: [citizenId], references: [id])
  worker  User? @relation("WorkerRequests", fields: [workerId], references: [id])
}

model GarbageReport {
  id        Int      @id @default(autoincrement())
  imagePath String
  latitude  Float
  longitude Float
  status    String   @default("REPORTED") // REPORTED, APPROVED, ASSIGNED, IN_PROGRESS, COMPLETED, REJECTED
  citizenId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // New fields for enhanced workflow
  preferredDate DateTime? // Preferred pickup date
  address      String?   // Pickup address
  notes        String?   // Citizen notes
  adminNotes   String?   // Admin notes
  statusHistory String?  // JSON string of status transitions
  assignedWorkerId Int?  // Direct worker assignment

  // Relations
  citizen User     @relation(fields: [citizenId], references: [id])
  tasks   Task[]
  assignedWorker User? @relation("WorkerAssignments", fields: [assignedWorkerId], references: [id])
}

model Task {
  id               Int       @id @default(autoincrement())
  garbageReportId  Int?
  latitude         Float
  longitude        Float
  scheduledTime    DateTime
  status           String    @default("ASSIGNED") // ASSIGNED, IN_PROGRESS, COMPLETED
  workerId         Int
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  // New fields for enhanced workflow
  statusHistory String?  // JSON string of status transitions
  completedAt    DateTime? // When task was marked completed

  // Relations
  garbageReport GarbageReport? @relation(fields: [garbageReportId], references: [id])
  worker        Worker        @relation(fields: [workerId], references: [id])
}

model Worker {
  id             Int     @id @default(autoincrement())
  userId         Int     @unique
  currentWorkload Int    @default(0)
  maxTasks       Int     @default(10)

  // Relations
  user  User   @relation(fields: [userId], references: [id])
  tasks Task[]
}

model AILog {
  id        Int      @id @default(autoincrement())
  decision  String
  reason    String
  timestamp DateTime @default(now())
}